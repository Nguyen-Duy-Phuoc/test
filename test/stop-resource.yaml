steps:
  - name: gcr.io/cloud-builders/kubectl
    args:
      - '-c'
      - | 
        set -ex
        if ! gcloud container clusters get-credentials gke-tera-dev --region asia-southeast1 --project tera-projects-dev; then
          echo "Error: Failed to get Kubernetes credentials."
          exit 1
        fi
        kubectl get app -n argocd --no-headers -o custom-columns=":metadata.name" | xargs -I {} kubectl patch app {} -n argocd --type merge -p '{"spec":{"syncPolicy":{"automated":{"selfHeal": false}}}}'
        for ns in airbyte ecommerce elasticsearch oneloyalty-ns onereels onlala onstudio show-hub yvote ; do
          echo "- $ns"
        done 
        for ns in airbyte ecommerce elasticsearch oneloyalty-ns onereels onlala onstudio show-hub yvote; do
          kubectl scale deployments --all --replicas=0 -n "$ns"
        done
        for ns in airbyte-backup elasticsearch oneloyalty-ns onstudio logging kube-infra; do
          echo "- $ns1"
        done 
        for ns in airbyte-backup elasticsearch oneloyalty-ns onstudio logging kube-infra; do
          kubectl scale statefulsets --all --replicas=0 -n "$ns1"
        done
        kubectl scale statefulsets --all --replicas=0 -n airbyte-backup
        kubectl scale statefulsets --all --replicas=0 -n elasticsearch 
        kubectl scale statefulsets --all --replicas=0 -n oneloyalty-ns
        kubectl scale statefulsets --all --replicas=0 -n onstudio
        kubectl scale statefulsets --all --replicas=0 -n logging
        kubectl scale statefulsets --all --replicas=0 -n kube-infra
    entrypoint: bash
options:
  logging: CLOUD_LOGGING_ONLY
